<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GD Level Downloader</title>
</head>
<body>
  <h2>Download GMD</h2>
  <form id="form">
    <label for="levelId">Level ID:</label>
    <input type="text" id="levelId" name="levelId" required>
    <button type="submit">Download</button>
  </form>
  <p id="status"></p>

  <script>
    const USERSCRIPT_URL = "https://github.com/ryder7223/GDServerTools/raw/refs/heads/main/downloadGMDClient.user.js";

    const kTagMap = [
      ["kCEK", "static", 4],
      ["k1", "1"],
      ["k23", "15"],
      ["k2", "2"],
      ["k4", "4"],
      ["k3", "3"],
      ["k21", "static", 3],
      ["k16", "5"],
      ["k17", "13"],
      ["k80", "46"],
      ["k81", "47"],
      ["k64", "37"],
      ["k42", "30"],
      ["k45", "35"],
      ["k50", "static", 45],
      ["k48", "45"]
    ];

    function parseLevelData(data) {
      const pairs = {};
      const parts = data.trim().split(":");
      for (let i = 0; i < parts.length - 1; i += 2) {
        const key = parts[i];
        const value = parts[i + 1].split(";")[0];
        pairs[key] = value;
      }
      return pairs;
    }

    function makeGmd(levelId, pairs) {
      const xml = ['<?xml version="1.0"?><plist version="1.0" gjver="2.0"><dict>'];
      const stringTags = new Set(["k2", "k4", "k3"]);

      for (const row of kTagMap) {
        const ktag = row[0];
        const rawKey = row[1];
        const v = rawKey === "static" ? row[2] : (pairs[rawKey] ?? null);
        if (v === null || v === "") continue;
        const tagType = stringTags.has(ktag) ? "s" : "i";
        xml.push(`<k>${ktag}</k><${tagType}>${v}</${tagType}>`);
      }

      xml.push("</dict></plist>");
      return xml.join("");
    }

    function safeFileName(name) {
      return name.replace(/[^a-zA-Z0-9_\- ]/g, "_");
    }

    function downloadBlob(blob, fileName) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      a.click();
      URL.revokeObjectURL(url);
    }

    function isUserscriptInstalled() {
      return Boolean(window.__boomlingsUserscriptEnabled);
    }

    function showUserscriptInstallMessage() {
      const statusEl = document.getElementById("status");
      statusEl.innerHTML = `
        Userscript not detected.<br>
        Please install it here:<br>
        <a href="${USERSCRIPT_URL}" target="_blank">${USERSCRIPT_URL}</a>
      `;
      statusEl.style.color = "red";
    }

    function waitForUserscript(maxWaitMs = 3000, intervalMs = 100) {
      return new Promise((resolve) => {
        const start = Date.now();
        const interval = setInterval(() => {
          if (isUserscriptInstalled()) {
            clearInterval(interval);
            resolve(true);
          } else if (Date.now() - start >= maxWaitMs) {
            clearInterval(interval);
            resolve(false);
          }
        }, intervalMs);
      });
    }

    function fetchViaUserscript(levelId, timeoutMs = 15000) {
      return new Promise((resolve, reject) => {
        const handleMessage = (event) => {
          const msg = event?.data;
          if (!msg || msg.type !== "boomlingsDownloadResult" || String(msg.levelID) !== String(levelId)) return;

          window.removeEventListener("message", handleMessage);
          clearTimeout(timer);

          if (!msg.ok) reject(new Error(msg.error || "Userscript request failed"));
          else resolve(String(msg.text || ""));
        };

        const timer = setTimeout(() => {
          window.removeEventListener("message", handleMessage);
          reject(new Error("Userscript request timed out"));
        }, timeoutMs);

        window.addEventListener("message", handleMessage);
        window.postMessage({ type: "boomlingsDownload", levelID: levelId }, "*");
      });
    }

    const form = document.getElementById("form");
    const statusEl = document.getElementById("status");

    window.addEventListener("load", async () => {
      const installed = await waitForUserscript(3000);
      if (!installed) {
        showUserscriptInstallMessage();
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const levelId = document.getElementById("levelId").value.trim();
      if (!levelId) return;

      statusEl.textContent = "Checking userscript...";
      statusEl.style.color = "";

      const installed = await waitForUserscript(3000);
      if (!installed) {
        showUserscriptInstallMessage();
        return;
      }

      statusEl.textContent = "Fetching level...";

      try {
        const text = await fetchViaUserscript(levelId);

        if (text.trim() === "-1") {
          statusEl.textContent = "Level not found.";
          statusEl.style.color = "red";
          return;
        }

        const pairs = parseLevelData(text);
        const gmdContent = makeGmd(levelId, pairs);
        const levelName = pairs["2"] || `level_${levelId}`;
        const safeName = safeFileName(levelName);
        const fileName = `${levelId} - ${safeName}.gmd`;

        const blob = new Blob([gmdContent], { type: "application/octet-stream" });
        downloadBlob(blob, fileName);

        statusEl.textContent = `Downloaded: ${fileName}`;
        statusEl.style.color = "green";
      } catch (err) {
        statusEl.textContent = `Error: ${err.message}`;
        statusEl.style.color = "red";
      }
    });
  </script>
</body>
</html>